name: Deploy magda-web-server

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "The branch or ref to deploy"
        required: true
        default: "next"

env:
  AWS_DEFAULT_REGION: ap-southeast-2

jobs:
  deployment:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: actions/checkout@v3
        with:
          ref: "next"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::940728446396:role/GitHubRole-Deploy-FN5IHCDG5R5O
          aws-region: ${{env.AWS_DEFAULT_REGION}}

      - name: helm deploy
        uses: tensor-hq/eksctl-helm-action@master
        with:
          eks_cluster: magda-test
          command: |-
            helm dep up deploy/helm/wsp-magda
            helm upgrade --namespace magda --install magda deploy/helm/wsp-magda -f deploy/helm/wsp-deploy-test.yml --set "magda.magda-core.web-server.image.tag=${GITHUB_SHA::8}"

