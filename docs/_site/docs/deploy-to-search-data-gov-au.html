<!DOCTYPE html>
<html lang=" en-US ">

<head>
    <meta charset="UTF-8"> <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Create a release branch | magda</title>
<meta name="generator" content="Jekyll v3.7.3" />
<meta property="og:title" content="Create a release branch" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A complete solution for managing, publishing and discovering government data, private and open." />
<meta property="og:description" content="A complete solution for managing, publishing and discovering government data, private and open." />
<link rel="canonical" href="http://localhost:4000/docs/deploy-to-search-data-gov-au.html" />
<meta property="og:url" content="http://localhost:4000/docs/deploy-to-search-data-gov-au.html" />
<meta property="og:site_name" content="magda" />
<script type="application/ld+json">
{"url":"http://localhost:4000/docs/deploy-to-search-data-gov-au.html","description":"A complete solution for managing, publishing and discovering government data, private and open.","headline":"Create a release branch","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=607cfec1a68d89f4e2e9c69ebec2c0f8fb1511b7">
</head>

<body>
    <header class="page-header" role="banner">
        <h1 class="project-name">
            <img src="/magda-inverse.svg" alt="magda" style="max-height: 100px">
        </h1>
        <h2 class="project-tagline">A complete solution for managing, publishing and discovering government data, private and open.</h2>
        
    </header>

    <main id="content" class="main-content" role="main">
        <h3 id="create-a-release-branch">Create a release branch</h3>

<p>This should happen just before or after a complete QA of the system. During the test issues will be created for bugs found - if any are release blockers, the PRs that fix them should be based on this release branch. Anything else should be based on <code class="highlighter-rouge">master</code>.</p>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Check out master and ensure you don’t have any extra changes</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout master
git status
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><code class="highlighter-rouge">git pull</code></p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Check this out into a release branch</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout -b release/0.0.x
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Run <code class="highlighter-rouge">lerna publish</code> to bump the version number to a Release Candidate version (`v<em>.</em>.*-RC1)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lerna publish <span class="nt">--skip-npm</span> <span class="nt">--skip-git</span> <span class="nt">--force-publish</span>
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Use a text editor to do a find-and-replace-in-project for the old version to make sure that there’s not extra references to the old version number lying around. In particular update the prod config to point at this new version. Also make sure to change <code class="highlighter-rouge">deploy/helm/magda/Chart.yaml</code>.</p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Commit and push.</p>
  </li>
</ul>

<h3 id="bump-version-in-master">Bump version in master</h3>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Run <code class="highlighter-rouge">lerna publish</code> to bump the version number to a the next development version (x.x.x-0).</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout master
lerna publish <span class="nt">--skip-npm</span> <span class="nt">--skip-git</span> <span class="nt">--force-publish</span>
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Use a text editor to do a find-and-replace-in-project for the old version to make sure that there’s not extra references to the old version number lying around - we want to automate this whereever possible but it happens. Ensure that the prod config continues to point at a release version, but the dev config should point at the new version. Also make sure to change <code class="highlighter-rouge">deploy/helm/magda/Chart.yaml</code>.</p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Commit the changes and create a PR against <code class="highlighter-rouge">master</code> for the version bump.</p>
  </li>
</ul>

<h3 id="when-all-release-blocker-bugs-resolved-release-the-rc">(When all release-blocker bugs resolved) Release the RC</h3>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Check out the release branch and make sure it’s up to date, then tag it as an RC and push it.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout release/x.x.x
git pull
git tag vx.x.x-RC1 <span class="c"># The "v" in the tag is very important!!</span>
git push vx.x.x-RC1
</code></pre></div></div>

<p>This will cause a slightly different build pipeline to run - it will automatically push images to docker hub with the current version as specified in the root package json and create a full preview at https://vx-x-x-rc1.dev.magda.io using those images.</p>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Test https://vx-x-x-rc1.dev.magda.io. If it succeeds then proceed, otherwise fix it and go back to “Release the RC”, bumping the RC version by one.</p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Shut down the staging namespace in Gitlab.</p>
  </li>
</ul>

<h3 id="publish-to-prod">Publish to prod</h3>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Connect to the prod cluster</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config use-context &lt;prod-cluster-name&gt;
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Check if there’s been any changes to the search index definitions <code class="highlighter-rouge">magda-scala-common/src/main/resources/common.conf</code> since the last release branch.</p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Helm upgrade prod</p>
  </li>
</ul>

<p>If there were changes to the index versions, you’ll need to set the search api to still point at the previous version of the index while the indexer builds the new one:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm upgrade magda <span class="nt">--timeout</span> 999999999 <span class="nt">--wait</span> <span class="nt">-f</span> deploy/helm/search-data-gov-au.yml deploy/helm/magda <span class="nt">--set</span> search-api.datasetsIndexVersion<span class="o">=</span>&lt;version&gt;,search-api.regionsIndexVersion<span class="o">=</span>&lt;version&gt;
</code></pre></div></div>

<p>Once the indexer has finished (watch <code class="highlighter-rouge">kubectl logs -f &lt;indexer pod name&gt;</code>) or if there’s no changes to the indices:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm upgrade magda <span class="nt">--timeout</span> 999999999 <span class="nt">--wait</span> <span class="nt">-f</span> deploy/helm/search-data-gov-au.yml deploy/helm/magda
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Look at the logs on magda-registry and the webhooks table of the database to make sure it’s processing webhooks again</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs -f &lt;registry-api-pod-name&gt;
kubectl port-forward &lt;cloud-sql-proxy-pod-name&gt; 5432:5432
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Generate/deploy new cron jobs</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>deploy
yarn run create-connector-configmap
yarn run generate-connector-jobs-prod
mkdir kubernetes/generated/prod/cron
mv kubernetes/generated/prod/<span class="k">*</span><span class="nt">-cron</span>.json kubernetes/generated/prod/cron
kubectl apply <span class="nt">-f</span> kubernetes/generated/prod/cron
<span class="nb">cd</span> ..
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Test on prod:</p>

    <ul>
      <li>Make sure Google Analytics is reporting your presence</li>
      <li>Do a regression test</li>
      <li>Ensure that prod-specific settings (particularly absence of user accounts) are in place correctly</li>
      <li>If there’s a problem then go back to “Release the RC”, bumping the RC version by one.</li>
      <li>Also do a post-mortem so this doesn’t happen again. Things going wrong in dev is ok, but they shouldn’t break in prod!</li>
    </ul>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Mark the tag as a pre-release in github</p>
  </li>
</ul>

<h3 id="merge-the-changes-in-the-release-branch-back-into-master">Merge the changes in the release branch back into master</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout &lt;release-branch&gt;
git checkout -b merge-&lt;version&gt;
lerna publish --force-publish --skip-npm --skip-git # Set version to same as master
# Also make sure any other version (particularly in Chart.yaml) is updated
git pull origin master
git push origin merge-&lt;version&gt;
</code></pre></div></div>

<p>And open a PR on master.</p>

<h3 id="push-the-previous-rc-of-last-version-as-a-release">Push the previous RC of last version as a release</h3>

<p>Now we’ve released a whole new version, presumably the previous version on prod proved stable enough to release as not an RC, so lets release that as a proper release.</p>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Check out last version’s release branch</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout release/x.x.x
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Set the version number as an actual release version (no “-RCx”) and push it to docker and github</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lerna publish <span class="nt">--skip-npm</span> <span class="nt">--skip-git</span> <span class="nt">--force-publish</span>
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Use a text editor to correct any references to the RC version that didn’t get changed.</p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Commit and tag as vx.x.x, then push the tag</p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Retag the last RC docker images as the new version</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run retag-and-push <span class="nt">--</span> <span class="nt">--</span> <span class="nt">--fromVersion</span><span class="o">=</span>x.x.x-RC1 <span class="nt">--toVersion</span><span class="o">=</span>x.x.x
</code></pre></div></div>

<ul class="task-list">
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Set that latest tag as a “release” in github.</p>
  </li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Delete the release branch in github</p>
  </li>
</ul>


        <footer class="site-footer">
            <span class="site-footer-credits">This page was generated by
                <a href="https://pages.github.com">GitHub Pages</a>.</span>
        </footer>
    </main>

    
</body>

</html>