<%- include( '_head.ejs' ) %>

	<div class="outer">
		<div class="inner" id="body">

    </div>
  </div>


<script type="text/babel" data-presets="es2017">
	const instanceURL = '/api/v0';

  window.onload = function()
  {
    refresh();
  };

  async function refresh()
  {
    const body = d3.select('#body').text('Loading...');

    try {

      const me = await request('GET', `${instanceURL}/auth/users/whoami`);
      body.text('')

      if (!me.isAdmin) {
        body.append('P').text(`Hi ${me.displayName}, you are not an admin!`);
        return;
      }

      body.append('H2').text('Logo');
      body.append('img').attr('src', `${instanceURL}/content/logo.bin`)
        .style('max-width', `200px`);

      body.append('button').text('Change').on('click', () =>
      {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*'
        input.click();
        input.onchange = function() {
          const file = input.files[0];
          const fileReader = new FileReader();
          fileReader.onloadend = async function (e) {
							const data = new Blob([new Uint8Array(e.target.result)]);
              await request('POST', `${instanceURL}/content/logo`, data, file.type);
              alert('DONE');
          };
          fileReader.readAsArrayBuffer(file);
        }
      });

      body.append('pre').text(JSON.stringify(me, null, 2));

    } catch (e) {

      body.append('pre').text(e);

      body.append('p').html(`Are you logged in? Try <a href="${instanceURL.substr(0, instanceURL.indexOf('/', 9))}/auth">here</a>.`);
    }
  }

  function request(method, url, body=null, contentType=undefined)
  {
    const headers = {

    };
    if (contentType) {
      headers['Content-Type'] = contentType;
    }
    if (contentType === 'application/json')
    {
      body = JSON.stringify(body);
    }
    const mode = "cors";
    const credentials = 'include';
    return d3.json(url, {method, headers, body, mode, credentials});
  }
</script>

<%- include( '_tail.ejs' ) %>
